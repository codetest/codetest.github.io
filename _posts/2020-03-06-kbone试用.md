# kbone
## 起源
在浏览公众号推送的时候，接收到一篇关于小程序和web端跨平台开发的文章。微信官方推出了kbone框架。kbone的一大原理是运行时实现兼容，而不是像其他框架，根据各个平台编译出不同的静态代码。具体的原理，可以参考[Kbone原理解析 & 小程序技术选型](https://developers.weixin.qq.com/community/develop/article/doc/0006a6326b8d38e56b998833456813)

## Build from scratch
kbone官方自然给出了立刻可用的模板，从快速开发的角度，每个人都可以基于模板进行修改。但还是愿意花时间一步步开发项目。具体参考了[kbone 项目搭建流程](https://wechat-miniprogram.github.io/kbone/docs/guide/tutorial.html)。下面就以vue为例，一步步搭建项目。

### package.json
第一步是实现一个单纯的vue+typescript开发的界面。那么需要以下的依赖库，typescript, ts-loader, vue-loader, mp-webpack-plugin, vue-property-decorator, vue-template-compiler, webpack, webpack-cli
```powershell
npm init -y
npm install --save vue vue-property-decorator
npm install --save-dev typescript ts-loader vue-loader mp-webpack-plugin vue-template-compiler webpack-cli
```

### tsconfig.json
以下为typescript的配置文件
```json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "es2015",
    "strict": true,
    "jsx": "preserve",
    "importHelpers": true,
    "moduleResolution": "node",
    "experimentalDecorators": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "sourceMap": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "src/*"
      ]
    },
    "lib": [
      "es2015", "es2017", "dom"
    ]
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx",
    "src/**/*.vue",
  ],
  "exclude": [
    "node_modules"
  ]
}
```

### 编译文件
kbone是使用webpack进行编译的，按照[官方指引](https://wechat-miniprogram.github.io/kbone/docs/guide/tutorial.html#%E7%BC%96%E5%86%99-webpack-%E9%85%8D%E7%BD%AE)，对配置文件进行删减。
```javascript
const path = require('path')
const webpack = require('webpack')
const { VueLoaderPlugin } = require('vue-loader')
const MpPlugin = require('mp-webpack-plugin') // 用于构建小程序代码的 webpack 插件，生成project.config.json和app.json

const mpConfig = {
    // 页面 origin，默认是 https://miniprogram.default
    origin: 'https://test.miniprogram.com',
    // 入口页面路由，默认是 /
    entry: '/',
    // 页面路由，用于页面间跳转
    router: {
        // 路由可以是多个值，支持动态路由
        home: [
            '/(home|index)?',
            '/test/(home|index)',
        ],
        list: [
            '/test/list/:id',
        ],
        detail: [
            '/test/detail/:id',
        ],
    },
    // 项目配置，会被合并到 project.config.json
    projectConfig: {
        appid: 'wx1234567890',
        projectname: 'kbone-demo',
    },
}

module.exports = {
    mode: 'production',
    entry: {
        home: path.resolve(__dirname, '../src/home/main.mp.js'),
        list: path.resolve(__dirname, '../src/list/main.mp.js'),
        detail: path.resolve(__dirname, '../src/detail/main.mp.js'),
    },
    output: {
        path: path.resolve(__dirname, './miniprogram/common'), // 放到小程序代码目录中的 common 目录下
        filename: '[name].js', // 必需字段，不能修改
        library: 'createApp', // 必需字段，不能修改
        libraryExport: 'default', // 必需字段，不能修改
        libraryTarget: 'window', // 必需字段，不能修改
    },
    target: 'web', // 必需字段，不能修改
    optimization: {
        runtimeChunk: false, // 必需字段，不能修改
        splitChunks: { // 代码分割配置，不建议修改
            chunks: 'all',
            minSize: 1000,
            maxSize: 0,
            minChunks: 1,
            maxAsyncRequests: 100,
            maxInitialRequests: 100,
            automaticNameDelimiter: '~',
            name: true,
            cacheGroups: {
                vendors: {
                    test: /[\\/]node_modules[\\/]/,
                    priority: -10
                },
                default: {
                    minChunks: 2,
                    priority: -20,
                    reuseExistingChunk: true
                }
            }
        },
    },
    plugins: [
        new webpack.DefinePlugin({
            'process.env.isMiniprogram': process.env.isMiniprogram, // 注入环境变量，用于业务代码判断
        }),
        new VueLoaderPlugin(),
        new MpPlugin(mpConfig)
    ],
}
```
根据以上的webpcak文件配置，需要额外安装开发依赖库
```powershell
npm install --save-dev webpack vue-loader mp-webpack-plugin
```
